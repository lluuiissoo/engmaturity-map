<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Engineering Maturity Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="data.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #242836;
      --border: #2e3348;
      --text: #e1e4ed;
      --text-muted: #8b90a0;
      --accent: #6c8cff;
      --accent-dim: rgba(108,140,255,0.15);
      --target: rgba(255,170,50,0.6);
      --target-fill: rgba(255,170,50,0.08);
      --current: rgba(108,140,255,0.8);
      --current-fill: rgba(108,140,255,0.15);
      --level1: #ef4444;
      --level2: #f97316;
      --level3: #eab308;
      --level4: #22c55e;
      --level5: #06b6d4;
      --gap-high: #ef4444;
      --gap-med: #f97316;
      --gap-low: #eab308;
      --gap-none: #22c55e;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    header h1 { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }

    .filters {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filters label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    select, input[type="text"] {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      outline: none;
    }

    select:focus, input:focus { border-color: var(--accent); }

    .tabs {
      display: flex;
      gap: 2px;
      background: var(--surface2);
      border-radius: 8px;
      padding: 3px;
    }

    .tab {
      padding: 5px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-muted);
      border: none;
      background: transparent;
      transition: all 0.15s;
    }

    .tab.active { background: var(--accent); color: #fff; }
    .tab:hover:not(.active) { color: var(--text); }

    /* --- Depth toggle (Dimensions vs Sub-dimensions) --- */
    .depth-toggle {
      display: flex;
      gap: 2px;
      background: var(--surface2);
      border-radius: 8px;
      padding: 3px;
    }

    .depth-btn {
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-muted);
      border: none;
      background: transparent;
      transition: all 0.15s;
    }

    .depth-btn.active { background: #7c5cbf; color: #fff; }
    .depth-btn:hover:not(.active) { color: var(--text); }

    /* --- Dimension filter for sub-dimension drill-down --- */
    .dim-filter {
      display: none;
      gap: 10px;
      align-items: center;
    }

    .dim-filter.visible { display: flex; }

    .stats-bar {
      display: flex;
      gap: 24px;
      padding: 12px 32px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .stat { display: flex; flex-direction: column; gap: 2px; }

    .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }

    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    main { padding: 20px 32px; }

    /* --- Radar View --- */
    #radar-view .radar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .radar-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      transition: border-color 0.15s;
    }

    .radar-card:hover { border-color: var(--accent); }

    .radar-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .radar-card-title { font-size: 13px; font-weight: 600; }

    .radar-card-meta { display: flex; gap: 6px; align-items: center; }

    .badge { font-size: 10px; padding: 2px 7px; border-radius: 4px; font-weight: 500; }
    .badge-type { background: var(--accent-dim); color: var(--accent); }
    .badge-team { background: rgba(255,255,255,0.06); color: var(--text-muted); }
    .badge-tier { font-weight: 700; }
    .badge-tier-1 { background: rgba(239,68,68,0.15); color: #ef4444; }
    .badge-tier-2 { background: rgba(249,115,22,0.15); color: #f97316; }
    .badge-tier-3 { background: rgba(234,179,8,0.15); color: #eab308; }

    .avg-score { font-size: 12px; color: var(--text-muted); }
    .avg-score strong { color: var(--text); font-size: 14px; }

    /* --- Heatmap View --- */
    #heatmap-view { overflow-x: auto; }

    .heatmap-table { width: 100%; border-collapse: collapse; font-size: 12px; }

    .heatmap-table th {
      text-align: left;
      padding: 8px 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--text-muted);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }

    .heatmap-table th.dim-group-header {
      text-align: center;
      background: var(--surface2);
      border-left: 2px solid var(--border);
      font-size: 11px;
      color: var(--accent);
    }

    .heatmap-table th.sub-header {
      font-size: 9px;
      text-align: center;
      padding: 4px 4px;
      border-left: 1px solid var(--border);
    }

    .heatmap-table th.sub-header-first {
      border-left: 2px solid var(--border);
    }

    .heatmap-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }

    .heatmap-table tr:hover td { background: var(--surface2); }

    .heatmap-cell {
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      border-left: 1px solid var(--border);
    }

    .heatmap-cell-first { border-left: 2px solid var(--border); }

    .heatmap-cell .gap-indicator {
      font-size: 9px;
      font-weight: 400;
      display: block;
      margin-top: 1px;
    }

    .repo-name-cell { font-weight: 500; white-space: nowrap; }
    .repo-type-cell { color: var(--text-muted); font-size: 11px; }

    /* --- Gap Analysis View --- */
    #gap-view .gap-list { display: flex; flex-direction: column; gap: 6px; }

    .gap-row {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      display: grid;
      grid-template-columns: 180px 40px 140px 120px 1fr 70px;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .gap-row-repo { font-weight: 600; }
    .gap-row-dim { color: var(--accent); font-size: 12px; }
    .gap-row-sub { color: var(--text-muted); font-size: 12px; }

    .gap-bar-track {
      height: 8px;
      background: var(--surface2);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .gap-bar-current { height: 100%; border-radius: 4px; transition: width 0.3s; }

    .gap-bar-target {
      position: absolute;
      top: -3px;
      width: 2px;
      height: 14px;
      background: var(--target);
      border-radius: 1px;
    }

    .gap-score { text-align: right; font-weight: 700; font-size: 13px; }

    /* --- Aggregate Radar View --- */
    #aggregate-view .agg-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }

    .agg-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }

    .agg-card h3 { font-size: 15px; margin-bottom: 2px; }

    .agg-card .subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* --- Dimension Deep Dive View --- */
    #dimension-view .dim-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
      gap: 20px;
    }

    .dim-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }

    .dim-card h3 { font-size: 15px; margin-bottom: 2px; }
    .dim-card .subtitle { font-size: 11px; color: var(--text-muted); margin-bottom: 10px; }

    .dim-sub-scores {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }

    .dim-sub-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: var(--surface2);
      border-radius: 6px;
      font-size: 12px;
    }

    .dim-sub-item .sub-name { color: var(--text-muted); }
    .dim-sub-item .sub-scores { font-weight: 600; }

    .legend {
      display: flex;
      gap: 16px;
      padding: 8px 32px;
      font-size: 11px;
      color: var(--text-muted);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-swatch { width: 10px; height: 10px; border-radius: 3px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>
  <h1>Engineering Maturity Dashboard</h1>
  <div class="filters">
    <label>Type</label>
    <select id="filter-type"><option value="all">All Types</option></select>

    <label>Team</label>
    <select id="filter-team"><option value="all">All Teams</option></select>

    <label>Tier</label>
    <select id="filter-tier">
      <option value="all">All Tiers</option>
      <option value="1">Tier 1 — Critical</option>
      <option value="2">Tier 2 — Important</option>
      <option value="3">Tier 3 — Low-risk</option>
    </select>

    <label>Search</label>
    <input type="text" id="filter-search" placeholder="Filter repos...">

    <div class="depth-toggle">
      <button class="depth-btn active" data-depth="dimensions">Dimensions</button>
      <button class="depth-btn" data-depth="subdimensions">Sub-dimensions</button>
    </div>

    <div class="dim-filter" id="dim-filter">
      <label>Dimension</label>
      <select id="filter-dimension"><option value="all">All Dimensions</option></select>
    </div>

    <div class="tabs">
      <button class="tab active" data-view="radar">Radar</button>
      <button class="tab" data-view="aggregate">By Type</button>
      <button class="tab" data-view="dimension">By Dimension</button>
      <button class="tab" data-view="heatmap">Heatmap</button>
      <button class="tab" data-view="gap">Gap Analysis</button>
    </div>
  </div>
</header>

<div class="legend">
  <div class="legend-item"><div class="legend-swatch" style="background:var(--current)"></div> Current</div>
  <div class="legend-item"><div class="legend-swatch" style="background:var(--target)"></div> Target</div>
  <div class="legend-item"><div class="legend-swatch" style="background:var(--level1)"></div> 1 Ad-hoc</div>
  <div class="legend-item"><div class="legend-swatch" style="background:var(--level2)"></div> 2 Basic</div>
  <div class="legend-item"><div class="legend-swatch" style="background:var(--level3)"></div> 3 Defined</div>
  <div class="legend-item"><div class="legend-swatch" style="background:var(--level4)"></div> 4 Managed</div>
  <div class="legend-item"><div class="legend-swatch" style="background:var(--level5)"></div> 5 Optimized</div>
  <span style="color:var(--border)">|</span>
  <div class="legend-item"><div class="legend-swatch" style="background:#ef4444"></div> Tier 1 Critical</div>
  <div class="legend-item"><div class="legend-swatch" style="background:#f97316"></div> Tier 2 Important</div>
  <div class="legend-item"><div class="legend-swatch" style="background:#eab308"></div> Tier 3 Low-risk</div>
</div>

<div class="stats-bar" id="stats-bar"></div>

<main>
  <div id="radar-view"><div class="radar-grid" id="radar-grid"></div></div>
  <div id="aggregate-view" class="hidden"><div class="agg-grid" id="agg-grid"></div></div>
  <div id="dimension-view" class="hidden"><div class="dim-grid" id="dim-grid"></div></div>
  <div id="heatmap-view" class="hidden"></div>
  <div id="gap-view" class="hidden"><div class="gap-list" id="gap-list"></div></div>
</main>

<script>
// ---- State ----
let currentView = 'radar';
let currentDepth = 'dimensions'; // 'dimensions' | 'subdimensions'
const chartInstances = new Map();

// ---- Utility ----
function levelColor(val) {
  if (val <= 1) return 'var(--level1)';
  if (val <= 1.5) return 'var(--level1)';
  if (val <= 2) return 'var(--level2)';
  if (val <= 3) return 'var(--level3)';
  if (val <= 4) return 'var(--level4)';
  return 'var(--level5)';
}

function gapColor(gap) {
  if (gap >= 3) return 'var(--gap-high)';
  if (gap >= 2) return 'var(--gap-med)';
  if (gap >= 1) return 'var(--gap-low)';
  return 'var(--gap-none)';
}

function tierBadge(tier) {
  return `<span class="badge badge-tier badge-tier-${tier}">T${tier}</span>`;
}

function getFiltered() {
  const type = document.getElementById('filter-type').value;
  const team = document.getElementById('filter-team').value;
  const tier = document.getElementById('filter-tier').value;
  const search = document.getElementById('filter-search').value.toLowerCase();
  return repos.filter(r =>
    (type === 'all' || r.type === type) &&
    (team === 'all' || r.team === team) &&
    (tier === 'all' || r.tier === parseInt(tier)) &&
    (search === '' || r.name.toLowerCase().includes(search))
  );
}

// Get the active items for radar/heatmap based on depth + dimension filter
function getActiveItems() {
  const dimFilter = document.getElementById('filter-dimension').value;
  if (currentDepth === 'dimensions') {
    return DIMENSIONS.map(d => ({ key: d.key, label: d.label, getValue: (scores) => dimScore(scores, d) }));
  } else {
    if (dimFilter === 'all') {
      // All sub-dimensions
      return DIMENSIONS.flatMap(d => d.subs.map(s => ({ key: s.key, label: s.label, dimLabel: d.label, getValue: (scores) => scores[s.key] || 0 })));
    } else {
      const dim = DIMENSIONS.find(d => d.key === dimFilter);
      return dim.subs.map(s => ({ key: s.key, label: s.label, dimLabel: dim.label, getValue: (scores) => scores[s.key] || 0 }));
    }
  }
}

// ---- Populate Filters ----
function initFilters() {
  const types = [...new Set(repos.map(r => r.type))].sort();
  const teams = [...new Set(repos.map(r => r.team))].sort();
  const typeSelect = document.getElementById('filter-type');
  const teamSelect = document.getElementById('filter-team');
  const dimSelect = document.getElementById('filter-dimension');

  types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; typeSelect.appendChild(o); });
  teams.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; teamSelect.appendChild(o); });
  DIMENSIONS.forEach(d => { const o = document.createElement('option'); o.value = d.key; o.textContent = d.label; dimSelect.appendChild(o); });
}

// ---- Stats Bar ----
function renderStats(filtered) {
  const bar = document.getElementById('stats-bar');
  const n = filtered.length;
  if (n === 0) { bar.innerHTML = '<div class="stat"><span class="stat-value">0</span><span class="stat-label">Repos</span></div>'; return; }
  const avgCur = (filtered.reduce((s, r) => s + overallScore(r.current), 0) / n).toFixed(1);
  const avgTar = (filtered.reduce((s, r) => s + overallScore(r.target), 0) / n).toFixed(1);
  const avgGap = (avgTar - avgCur).toFixed(1);
  const critical = filtered.filter(r => overallScore(r.current) < 2).length;
  const t1 = filtered.filter(r => r.tier === 1).length;
  const t2 = filtered.filter(r => r.tier === 2).length;
  const t3 = filtered.filter(r => r.tier === 3).length;

  // Per-dimension avg
  const dimStats = DIMENSIONS.map(d => {
    const avg = (filtered.reduce((s, r) => s + dimScore(r.current, d), 0) / n).toFixed(1);
    return `<div class="stat"><span class="stat-value" style="color:${levelColor(parseFloat(avg))}">${avg}</span><span class="stat-label">${d.label}</span></div>`;
  }).join('');

  bar.innerHTML = `
    <div class="stat"><span class="stat-value">${n}</span><span class="stat-label">Repos</span></div>
    <div class="stat"><span class="stat-value">${avgCur}</span><span class="stat-label">Avg Current</span></div>
    <div class="stat"><span class="stat-value">${avgTar}</span><span class="stat-label">Avg Target</span></div>
    <div class="stat"><span class="stat-value">${avgGap}</span><span class="stat-label">Avg Gap</span></div>
    <div class="stat"><span class="stat-value" style="color:${critical > 0 ? 'var(--level1)' : 'var(--level4)'}">${critical}</span><span class="stat-label">Critical</span></div>
    <div class="stat"><span class="stat-value" style="color:#ef4444">${t1}</span><span class="stat-label">Tier 1</span></div>
    <div class="stat"><span class="stat-value" style="color:#f97316">${t2}</span><span class="stat-label">Tier 2</span></div>
    <div class="stat"><span class="stat-value" style="color:#eab308">${t3}</span><span class="stat-label">Tier 3</span></div>
    ${dimStats}
  `;
}

// ---- Radar Chart Factory ----
function createRadarChart(canvas, currentData, targetData, labels, small = false) {
  const ctx = canvas.getContext('2d');
  return new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [
        {
          label: 'Current',
          data: currentData,
          borderColor: 'rgba(108,140,255,0.9)',
          backgroundColor: 'rgba(108,140,255,0.12)',
          borderWidth: 2,
          pointRadius: small ? 2 : 3,
          pointBackgroundColor: 'rgba(108,140,255,1)',
        },
        {
          label: 'Target',
          data: targetData,
          borderColor: 'rgba(255,170,50,0.7)',
          backgroundColor: 'rgba(255,170,50,0.06)',
          borderWidth: 2,
          borderDash: [5, 3],
          pointRadius: small ? 2 : 3,
          pointBackgroundColor: 'rgba(255,170,50,0.8)',
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: {
        r: {
          min: 0, max: 5,
          ticks: { stepSize: 1, display: !small, color: '#555', backdropColor: 'transparent', font: { size: 9 } },
          grid: { color: 'rgba(255,255,255,0.06)' },
          angleLines: { color: 'rgba(255,255,255,0.06)' },
          pointLabels: { color: '#8b90a0', font: { size: small ? 9 : 11 } },
        },
      },
    },
  });
}

function destroyCharts(prefix) {
  chartInstances.forEach((chart, key) => { if (key.startsWith(prefix)) { chart.destroy(); chartInstances.delete(key); } });
}

// ---- Radar View (per-repo) ----
function renderRadarView(filtered) {
  const grid = document.getElementById('radar-grid');
  destroyCharts('repo-');
  grid.innerHTML = '';

  const items = getActiveItems();
  const labels = items.map(i => i.label);

  filtered.forEach(repo => {
    const card = document.createElement('div');
    card.className = 'radar-card';
    const avgScore = overallScore(repo.current).toFixed(1);
    card.innerHTML = `
      <div class="radar-card-header">
        <div>
          <div class="radar-card-title">${repo.name}</div>
          <div class="radar-card-meta">
            ${tierBadge(repo.tier)}
            <span class="badge badge-type">${repo.type}</span>
            <span class="badge badge-team">${repo.team}</span>
          </div>
        </div>
        <div class="avg-score">Avg <strong>${avgScore}</strong>/5</div>
      </div>
      <canvas width="300" height="300"></canvas>
    `;
    grid.appendChild(card);

    const curData = items.map(i => i.getValue(repo.current));
    const tarData = items.map(i => i.getValue(repo.target));
    const chart = createRadarChart(card.querySelector('canvas'), curData, tarData, labels, true);
    chartInstances.set('repo-' + repo.name, chart);
  });
}

// ---- Aggregate View (by type) ----
function renderAggregateView(filtered) {
  const grid = document.getElementById('agg-grid');
  destroyCharts('agg-');
  grid.innerHTML = '';

  const items = getActiveItems();
  const labels = items.map(i => i.label);
  const groups = {};
  filtered.forEach(r => { if (!groups[r.type]) groups[r.type] = []; groups[r.type].push(r); });

  Object.keys(groups).sort().forEach(type => {
    const rg = groups[type];
    const curData = items.map(i => rg.reduce((s, r) => s + i.getValue(r.current), 0) / rg.length);
    const tarData = items.map(i => rg.reduce((s, r) => s + i.getValue(r.target), 0) / rg.length);
    const avgCur = (curData.reduce((a, b) => a + b, 0) / curData.length).toFixed(1);
    const avgTar = (tarData.reduce((a, b) => a + b, 0) / tarData.length).toFixed(1);

    const card = document.createElement('div');
    card.className = 'agg-card';
    card.innerHTML = `<h3>${type}</h3><div class="subtitle">${rg.length} repos — avg ${avgCur} / target ${avgTar}</div><canvas width="400" height="400"></canvas>`;
    grid.appendChild(card);

    const chart = createRadarChart(card.querySelector('canvas'), curData, tarData, labels, false);
    chartInstances.set('agg-' + type, chart);
  });
}

// ---- Dimension Deep Dive View ----
function renderDimensionView(filtered) {
  const grid = document.getElementById('dim-grid');
  destroyCharts('dim-');
  grid.innerHTML = '';
  const n = filtered.length;
  if (n === 0) return;

  DIMENSIONS.forEach(dim => {
    const card = document.createElement('div');
    card.className = 'dim-card';

    // Radar for this dimension's sub-dimensions (aggregated across filtered repos)
    const labels = dim.subs.map(s => s.label);
    const curData = dim.subs.map(s => filtered.reduce((sum, r) => sum + (r.current[s.key] || 0), 0) / n);
    const tarData = dim.subs.map(s => filtered.reduce((sum, r) => sum + (r.target[s.key] || 0), 0) / n);
    const avgCur = (curData.reduce((a, b) => a + b, 0) / curData.length).toFixed(1);
    const avgTar = (tarData.reduce((a, b) => a + b, 0) / tarData.length).toFixed(1);

    // Sub-score breakdown
    const subHtml = dim.subs.map(s => {
      const c = (filtered.reduce((sum, r) => sum + (r.current[s.key] || 0), 0) / n).toFixed(1);
      const t = (filtered.reduce((sum, r) => sum + (r.target[s.key] || 0), 0) / n).toFixed(1);
      return `<div class="dim-sub-item">
        <span class="sub-name">${s.label}</span>
        <span class="sub-scores" style="color:${levelColor(parseFloat(c))}">${c} <span style="color:var(--text-muted);font-weight:400">→</span> <span style="color:${levelColor(parseFloat(t))}">${t}</span></span>
      </div>`;
    }).join('');

    card.innerHTML = `
      <h3>${dim.label}</h3>
      <div class="subtitle">Avg current ${avgCur} / target ${avgTar} across ${n} repos</div>
      <canvas width="400" height="400"></canvas>
      <div class="dim-sub-scores">${subHtml}</div>
    `;
    grid.appendChild(card);

    const chart = createRadarChart(card.querySelector('canvas'), curData, tarData, labels, false);
    chartInstances.set('dim-' + dim.key, chart);
  });
}

// ---- Heatmap View ----
function renderHeatmapView(filtered) {
  const container = document.getElementById('heatmap-view');

  if (currentDepth === 'dimensions') {
    // Dimension-level heatmap
    const dimHeaders = DIMENSIONS.map(d => `<th>${d.label}</th>`).join('');
    const rows = filtered
      .sort((a, b) => overallScore(a.current) - overallScore(b.current))
      .map(repo => {
        const cells = DIMENSIONS.map(d => {
          const cur = dimScore(repo.current, d);
          const tar = dimScore(repo.target, d);
          const gap = tar - cur;
          return `<td class="heatmap-cell" style="background:${levelColor(cur)}22; color:${levelColor(cur)}">
            ${cur.toFixed(1)}
            ${gap > 0.1 ? `<span class="gap-indicator" style="color:${gapColor(gap)}">+${gap.toFixed(1)}</span>` : ''}
          </td>`;
        }).join('');
        return `<tr>
          <td class="repo-name-cell">${repo.name}</td>
          <td class="repo-type-cell">${tierBadge(repo.tier)}</td>
          <td class="repo-type-cell">${repo.type}</td>
          <td class="repo-type-cell">${repo.team}</td>
          <td style="font-weight:600;color:${levelColor(overallScore(repo.current))}">${overallScore(repo.current).toFixed(1)}</td>
          ${cells}
        </tr>`;
      }).join('');

    container.innerHTML = `<table class="heatmap-table">
      <thead><tr><th>Repo</th><th>Tier</th><th>Type</th><th>Team</th><th>Avg</th>${dimHeaders}</tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  } else {
    // Sub-dimension heatmap with grouped headers
    const dimFilter = document.getElementById('filter-dimension').value;
    const dimsToShow = dimFilter === 'all' ? DIMENSIONS : DIMENSIONS.filter(d => d.key === dimFilter);

    // Two header rows: dimension group + sub-dimension names
    const groupHeaders = dimsToShow.map(d =>
      `<th class="dim-group-header" colspan="${d.subs.length}">${d.label}</th>`
    ).join('');

    const subHeaders = dimsToShow.flatMap((d, di) => d.subs.map((s, si) =>
      `<th class="sub-header ${si === 0 ? 'sub-header-first' : ''}">${s.label}</th>`
    )).join('');

    const rows = filtered
      .sort((a, b) => overallScore(a.current) - overallScore(b.current))
      .map(repo => {
        const cells = dimsToShow.flatMap((d, di) => d.subs.map((s, si) => {
          const cur = repo.current[s.key] || 0;
          const tar = repo.target[s.key] || 0;
          const gap = tar - cur;
          return `<td class="heatmap-cell ${si === 0 ? 'heatmap-cell-first' : ''}" style="background:${levelColor(cur)}22; color:${levelColor(cur)}">
            ${cur}
            ${gap > 0 ? `<span class="gap-indicator" style="color:${gapColor(gap)}">+${gap}</span>` : ''}
          </td>`;
        })).join('');

        return `<tr>
          <td class="repo-name-cell">${repo.name}</td>
          <td class="repo-type-cell">${tierBadge(repo.tier)}</td>
          <td class="repo-type-cell">${repo.type}</td>
          <td class="repo-type-cell">${repo.team}</td>
          <td style="font-weight:600;color:${levelColor(overallScore(repo.current))}">${overallScore(repo.current).toFixed(1)}</td>
          ${cells}
        </tr>`;
      }).join('');

    container.innerHTML = `<table class="heatmap-table">
      <thead>
        <tr><th rowspan="2">Repo</th><th rowspan="2">Tier</th><th rowspan="2">Type</th><th rowspan="2">Team</th><th rowspan="2">Avg</th>${groupHeaders}</tr>
        <tr>${subHeaders}</tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
  }
}

// ---- Gap Analysis View ----
function renderGapView(filtered) {
  const list = document.getElementById('gap-list');
  const gaps = [];

  if (currentDepth === 'dimensions') {
    filtered.forEach(repo => {
      DIMENSIONS.forEach(d => {
        const cur = dimScore(repo.current, d);
        const tar = dimScore(repo.target, d);
        const gap = tar - cur;
        if (gap > 0.1) {
          gaps.push({ repo: repo.name, type: repo.type, tier: repo.tier, dim: d.label, sub: '', current: cur, target: tar, gap });
        }
      });
    });
  } else {
    const dimFilter = document.getElementById('filter-dimension').value;
    const dimsToScan = dimFilter === 'all' ? DIMENSIONS : DIMENSIONS.filter(d => d.key === dimFilter);
    filtered.forEach(repo => {
      dimsToScan.forEach(d => {
        d.subs.forEach(s => {
          const cur = repo.current[s.key] || 0;
          const tar = repo.target[s.key] || 0;
          const gap = tar - cur;
          if (gap > 0) {
            gaps.push({ repo: repo.name, type: repo.type, tier: repo.tier, dim: d.label, sub: s.label, current: cur, target: tar, gap });
          }
        });
      });
    });
  }

  gaps.sort((a, b) => b.gap - a.gap || a.current - b.current);

  list.innerHTML = gaps.slice(0, 150).map(g => `
    <div class="gap-row">
      <div class="gap-row-repo">${g.repo} <span style="font-weight:400;color:var(--text-muted);font-size:11px">${g.type}</span></div>
      <div>${tierBadge(g.tier)}</div>
      <div class="gap-row-dim">${g.dim}</div>
      <div class="gap-row-sub">${g.sub}</div>
      <div>
        <div class="gap-bar-track">
          <div class="gap-bar-current" style="width:${(g.current / 5) * 100}%; background:${levelColor(g.current)}"></div>
          <div class="gap-bar-target" style="left:${(g.target / 5) * 100}%"></div>
        </div>
      </div>
      <div class="gap-score" style="color:${gapColor(g.gap)}">${typeof g.current === 'number' && g.current % 1 !== 0 ? g.current.toFixed(1) : g.current} → ${typeof g.target === 'number' && g.target % 1 !== 0 ? g.target.toFixed(1) : g.target}</div>
    </div>
  `).join('');
}

// ---- View Switching ----
const viewIds = ['radar', 'aggregate', 'dimension', 'heatmap', 'gap'];

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  viewIds.forEach(v => {
    const el = document.getElementById(v + '-view');
    if (el) el.classList.toggle('hidden', v !== view);
  });
  renderCurrentView();
}

function setDepth(depth) {
  currentDepth = depth;
  document.querySelectorAll('.depth-btn').forEach(b => b.classList.toggle('active', b.dataset.depth === depth));
  document.getElementById('dim-filter').classList.toggle('visible', depth === 'subdimensions');
  renderCurrentView();
}

function renderCurrentView() {
  const filtered = getFiltered();
  renderStats(filtered);
  if (currentView === 'radar') renderRadarView(filtered);
  else if (currentView === 'aggregate') renderAggregateView(filtered);
  else if (currentView === 'dimension') renderDimensionView(filtered);
  else if (currentView === 'heatmap') renderHeatmapView(filtered);
  else if (currentView === 'gap') renderGapView(filtered);
}

// ---- Event Listeners ----
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchView(t.dataset.view)));
document.querySelectorAll('.depth-btn').forEach(b => b.addEventListener('click', () => setDepth(b.dataset.depth)));
document.getElementById('filter-type').addEventListener('change', renderCurrentView);
document.getElementById('filter-team').addEventListener('change', renderCurrentView);
document.getElementById('filter-tier').addEventListener('change', renderCurrentView);
document.getElementById('filter-search').addEventListener('input', renderCurrentView);
document.getElementById('filter-dimension').addEventListener('change', renderCurrentView);

// ---- Init ----
initFilters();
renderCurrentView();
</script>

</body>
</html>
